<!DOCTYPE html>
<html>
<head>
    <title>Pollen Forecast</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@splidejs/splide/dist/css/splide.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@splidejs/splide/dist/js/splide.min.js"></script>
</head>
    <body>
        <header>
            <h1>Pollen Forecast</h1>
        </header>
        <nav>
            <ul>
                <li><a href="home.html">Home</a></li>
                <li><a href="about.html">About</a></li>
                <li><a href="projectfunction.html">Forecast</a></li>
            </ul>
        </nav>
        <form id="forecastForm">
            <label for="location">Enter Location:</label>
            <input type="text" id="location" value="Houston, Texas">
            <button type="submit">Enter</button>
        </form>
        <div id="mainContainer">
            <div id="forecastContainer">
                <h4>Showing Forecast For: <span id="locationName"></span></h4>
                <section class="splide" aria-label="Pollen Forecast">
                    <div class="splide__track">
                        <div class="splide__list">
                            <!-- Slides will be dynamically added here -->
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </body>

</html>
<script>
    let splideInstance;

    document.getElementById('forecastForm').addEventListener('submit', async (event) => {
        event.preventDefault();

        const locationInput = document.getElementById('location').value;
        document.getElementById('locationName').innerText = locationInput;

        const [city, stateOrCountry] = locationInput.split(',').map((s) => s.trim());

        const statesDict_1 = {
            "AL": "Alabama",
            "AK": "Alaska",
            "AZ": "Arizona",
            "AR": "Arkansas",
            "CA": "California",
            "CZ": "Canal Zone",
            "CO": "Colorado",
            "CT": "Connecticut",
            "DE": "Delaware",
            "DC": "District of Columbia",
            "FL": "Florida",
            "GA": "Georgia",
            "GU": "Guam",
            "HI": "Hawaii",
            "ID": "Idaho",
            "IL": "Illinois",
            "IN": "Indiana",
            "IA": "Iowa",
            "KS": "Kansas",
            "KY": "Kentucky",
            "LA": "Louisiana",
            "ME": "Maine",
            "MD": "Maryland",
            "MA": "Massachusetts",
            "MI": "Michigan",
            "MN": "Minnesota",
            "MS": "Mississippi",
            "MO": "Missouri",
            "MT": "Montana",
            "NE": "Nebraska",
            "NV": "Nevada",
            "NH": "New Hampshire",
            "NJ": "New Jersey",
            "NM": "New Mexico",
            "NY": "New York",
            "NC": "North Carolina",
            "ND": "North Dakota",
            "OH": "Ohio",
            "OK": "Oklahoma",
            "OR": "Oregon",
            "PA": "Pennsylvania",
            "PR": "Puerto Rico",
            "RI": "Rhode Island",
            "SC": "South Carolina",
            "SD": "South Dakota",
            "TN": "Tennessee",
            "TX": "Texas",
            "UT": "Utah",
            "VT": "Vermont",
            "VI": "Virgin Islands",
            "VA": "Virginia",
            "WA": "Washington",
            "WV": "West Virginia",
            "WI": "Wisconsin",
            "WY": "Wyoming"
          }  
          let Url = `http://localhost:3001/api/geolocation?city=${city}`;
          if (stateOrCountry) {
              if (stateOrCountry.length ==2  && stateOrCountry in statesDict_1){
                  const fullStateName = statesDict_1[stateOrCountry];
      
                  Url += `&country=US&state=${fullStateName}`;
              }
              else if (Object.values(statesDict_1).includes(stateOrCountry)){
              Url += `&country=US&state=${stateOrCountry}`;}
              else{
               Url += `&country=${stateOrCountry}`;
              }
          }
        try {
            // Step 1: Get geolocation
            const geoResponse = await fetch(Url);
            if (!geoResponse.ok) throw new Error('Error fetching geolocation data');
            const [geoData] = await geoResponse.json();
            const { latitude, longitude } = geoData;
            console.log({ latitude, longitude } )

            // Step 2: Get pollen forecast
            const pollenResponse = await fetch(`http://localhost:3001/api/pollen?lat=${latitude}&long=${longitude}`);
            if (!pollenResponse.ok) throw new Error('Error fetching pollen data');
            const pollenData = await pollenResponse.json();

            console.log(pollenData); // Debugging purposes

            if (splideInstance) {
                splideInstance.destroy(true);
            }

            // Step 3: Display plant data in the carousel
            const container = document.querySelector('.splide__list');
            container.innerHTML = '';

            pollenData.dailyInfo[0].plantInfo.forEach((plant) => {
                const slide = document.createElement('div');
                slide.classList.add('splide__slide');
                slide.innerHTML = `
                    <p><strong>${plant.displayName}</strong></p>
                    ${plant.inSeason ? '<p>ðŸŒ± Currently in Season</p>' : ''}
                    <p>${plant.indexInfo?.value ? `Pollen Index: ${plant.indexInfo.value}` : ''}</p>
                `;

                // Add gauge image based on pollen index
                const gaugeImage = document.createElement('img');
                gaugeImage.src = plant.indexInfo?.value
                    ? `gauge (${plant.indexInfo.value}).png`
                    : 'gauge.png';
                gaugeImage.alt = `Pollen Index Gauge for ${plant.displayName}`;
                gaugeImage.style.width = '150px';
                slide.appendChild(gaugeImage);

                // Add any plant description image if available
                if (plant.plantDescription?.pictureCloseup) {
                    const plantImage = document.createElement('img');
                    plantImage.src = plant.plantDescription.pictureCloseup;
                    plantImage.alt = `${plant.displayName} Closeup`;
                    plantImage.style.maxWidth = '200px';
                    slide.appendChild(plantImage);
                }

                container.appendChild(slide);
            });
            

            // Initialize the Splide carousel
            splideInstance = new Splide('.splide', {
                type: 'loop',
                perPage: 3,
                perMove: 3,
                breakpoints: {
                    768: {
                        perPage: 1,
                    },
                    1024: {
                        perPage: 2,
                    },
                },
            });
            splideInstance.mount();
        } catch (error) {
            console.error(error);
            alert('An error occurred while fetching the forecast. Please try again.');
        }
    });
</script>
